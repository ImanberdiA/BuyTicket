{"version":3,"sources":["../../../libs/auth/auth.js"],"names":[],"mappings":";;AAAA,IAAI,QAAQ,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AACnC,IAAI,aAAa,GAAG,OAAO,CAAC,eAAe,CAAC,CAAC,aAAa,CAAC;AAC3D,IAAI,sBAAsB,GAAG,OAAO,CAAC,iCAAiC,CAAC,CAAC,QAAQ,CAAC;AACjF,IAAI,cAAc,GAAG,OAAO,CAAC,sBAAsB,CAAC,CAAC,QAAQ,CAAC;;AAE9D,IAAI,IAAI,GAAG,OAAO,CAAC,GAAG,EAAE,GAAG,QAAQ,CAAC;;AAEpC,IAAI,MAAM,GAAG,OAAO,CAAC,IAAI,GAAG,QAAQ,CAAC,CAAC;;AAEtC,IAAI,IAAI,GAAG,OAAO,CAAC,IAAI,GAAG,YAAY,CAAC,CAAC;AACxC,IAAI,MAAM,GAAG,OAAO,CAAC,IAAI,GAAG,cAAc,CAAC,CAAC;AAC5C,IAAI,WAAW,GAAG,OAAO,CAAC,IAAI,GAAG,mBAAmB,CAAC,CAAC;AACtD,IAAI,YAAY,GAAG,OAAO,CAAC,IAAI,GAAG,oBAAoB,CAAC,CAAC;;AAExD,QAAQ,CAAC,GAAG,CAAC,IAAI,aAAa,CAC1B,UAAS,QAAQ,EAAE,QAAQ,EAAE,IAAI,EAAE;AAC/B,UAAM,CAAC,OAAO,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,EAAE,UAAS,GAAG,EAAE,MAAM,EAAE;AACzD,YAAI,GAAG,EAAE;AACR,mBAAO,IAAI,CAAC,GAAG,CAAC,CAAC;SACjB;;AAED,YAAI,CAAC,MAAM,EAAE;AACZ,mBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;SACzB;;AAED,YAAI,MAAM,CAAC,YAAY,KAAK,QAAQ,EAAE;AACrC,mBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;SACzB;;AAED,eAAO,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;KAC7B,CAAC,CAAC;CACN,CACJ,CAAC,CAAC;;AAEH,QAAQ,CAAC,GAAG,CAAC,IAAI,sBAAsB,CACnC,UAAS,QAAQ,EAAE,YAAY,EAAE,IAAI,EAAE;AACnC,UAAM,CAAC,OAAO,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,EAAE,UAAS,GAAG,EAAE,MAAM,EAAE;AACzD,YAAI,GAAG,EAAE;AACR,mBAAO,IAAI,CAAC,GAAG,CAAC,CAAC;SACjB;;AAED,YAAI,CAAC,MAAM,EAAE;AACZ,mBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;SACzB;;AAED,YAAI,MAAM,CAAC,YAAY,KAAK,YAAY,EAAE;AACzC,mBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;SACzB;;AAED,eAAO,IAAI,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;KAC7B,CAAC,CAAC;CACN,CACJ,CAAC,CAAC;;AAEH,QAAQ,CAAC,GAAG,CAAC,IAAI,cAAc,CAC3B,UAAS,WAAW,EAAE,IAAI,EAAE;AACxB,eAAW,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,WAAW,EAAE,EAAE,UAAS,GAAG,EAAE,KAAK,EAAE;;AAE7D,YAAI,GAAG,EAAE;AACR,mBAAO,IAAI,CAAC,GAAG,CAAC,CAAC;SACjB;;AAED,YAAI,CAAC,KAAK,EAAE;AACX,mBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;SACzB;;AAED,YAAI,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE,GAAC,KAAK,CAAC,OAAO,CAAA,GAAE,IAAI,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC,oBAAoB,CAAC,EAAG;;AAEjF,uBAAW,CAAC,MAAM,CAAC,EAAE,KAAK,EAAE,WAAW,EAAE,EAAE,UAAU,GAAG,EAAE;AACtD,oBAAI,GAAG,EAAE;AACR,2BAAO,IAAI,CAAC,GAAG,CAAC,CAAC;iBACjB;aACJ,CAAC,CAAC;;AAEH,mBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,OAAO,EAAE,eAAe,EAAE,CAAC,CAAC;SAC1D;;AAED,YAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,MAAM,EAAE,UAAS,GAAG,EAAE,IAAI,EAAE;;AAE5C,gBAAI,GAAG,EAAE;AACR,uBAAO,IAAI,CAAC,GAAG,CAAC,CAAC;aACjB;;AAED,gBAAI,CAAC,IAAI,EAAE;AACV,uBAAO,IAAI,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;aACtD;;AAED,gBAAI,IAAI,GAAG,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC;AAC1B,gBAAI,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;SAC1B,CAAC,CAAC;KACN,CAAC,CAAC;CACN,CACJ,CAAC,CAAC","file":"auth.js","sourcesContent":["var passport = require('passport');\nvar BasicStrategy = require('passport-http').BasicStrategy;\nvar ClientPasswordStrategy = require('passport-oauth2-client-password').Strategy;\nvar BearerStrategy = require('passport-http-bearer').Strategy;\n\nvar libs = process.cwd() + '/libs/';\n\nvar config = require(libs + 'config');\n\nvar User = require(libs + 'model/user');\nvar Client = require(libs + 'model/client');\nvar AccessToken = require(libs + 'model/accessToken');\nvar RefreshToken = require(libs + 'model/refreshToken');\n\npassport.use(new BasicStrategy(\n    function(username, password, done) {\n        Client.findOne({ clientId: username }, function(err, client) {\n            if (err) { \n            \treturn done(err); \n            }\n\n            if (!client) { \n            \treturn done(null, false); \n            }\n\n            if (client.clientSecret !== password) { \n            \treturn done(null, false); \n            }\n\n            return done(null, client);\n        });\n    }\n));\n\npassport.use(new ClientPasswordStrategy(\n    function(clientId, clientSecret, done) {\n        Client.findOne({ clientId: clientId }, function(err, client) {\n            if (err) { \n            \treturn done(err); \n            }\n\n            if (!client) { \n            \treturn done(null, false); \n            }\n\n            if (client.clientSecret !== clientSecret) { \n            \treturn done(null, false); \n            }\n\n            return done(null, client);\n        });\n    }\n));\n\npassport.use(new BearerStrategy(\n    function(accessToken, done) {\n        AccessToken.findOne({ token: accessToken }, function(err, token) {\n\n            if (err) { \n            \treturn done(err); \n            }\n\n            if (!token) { \n            \treturn done(null, false); \n            }\n\n            if( Math.round((Date.now()-token.created)/1000) > config.get('security:tokenLife') ) {\n\n                AccessToken.remove({ token: accessToken }, function (err) {\n                    if (err) {\n                    \treturn done(err);\n                    } \n                });\n\n                return done(null, false, { message: 'Token expired' });\n            }\n\n            User.findById(token.userId, function(err, user) {\n            \n                if (err) { \n                \treturn done(err); \n                }\n\n                if (!user) { \n                \treturn done(null, false, { message: 'Unknown user' }); \n                }\n\n                var info = { scope: '*' };\n                done(null, user, info);\n            });\n        });\n    }\n));"]}